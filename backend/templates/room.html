<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LiveKit Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            margin-top: 20px;
        }
        #videos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        video {
            width: 100%;
            max-width: 500px;
            background: black;
            border-radius: 5px;
        }
        .warning {
            color: yellow;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Connecting to LiveKit Room...</h1>
    <div id="videos"></div>
    <div id="warnings"></div>

    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomName = urlParams.get("room");
        const token = urlParams.get("token");
        const videosDiv = document.getElementById("videos");
        const warningsDiv = document.getElementById("warnings");

        if (!roomName || !token) {
            document.body.innerHTML = "<p>Missing room or token in URL</p>";
        } else {
            const wsUrl = "wss://nothing-f9v9ildb.livekit.cloud";
            const room = new LivekitClient.Room();

            function attachTrack(track) {
                const element = track.attach();
                element.autoplay = true;
                element.playsInline = true;
                element.muted = track.source === 'microphone'; // mute local audio
                videosDiv.appendChild(element);
            }

            function addParticipantTracks(participant) {
                participant.tracks.forEach(pub => {
                    if (pub.track) attachTrack(pub.track);
                });
                participant.on(LivekitClient.ParticipantEvent.TrackSubscribed, track => {
                    attachTrack(track);
                });
            }

            room.on(LivekitClient.RoomEvent.ParticipantConnected, participant => {
                addParticipantTracks(participant);
            });

            room.connect(wsUrl, token).then(async () => {
                document.querySelector('h1').innerText = `Connected to ${roomName}`;

                // Attach tracks of already connected participants
                room.participants.forEach(addParticipantTracks);

                // Publish and attach local tracks safely
                try {
                    const localTracks = await LivekitClient.createLocalTracks({ audio: true, video: true });
                    localTracks.forEach(track => {
                        attachTrack(track);
                        room.localParticipant.publishTrack(track);
                    });
                } catch (err) {
                    console.warn("Could not access camera/mic:", err);
                    const warning = document.createElement('p');
                    warning.innerText = "Warning: Could not access camera/mic.";
                    warning.className = "warning";
                    warningsDiv.appendChild(warning);
                }

            }).catch(err => {
                console.error(err);
                document.body.innerHTML = "<p>Failed to connect to room</p>";
            });
        }
    </script>
</body>
</html>